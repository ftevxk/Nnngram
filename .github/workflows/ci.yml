name: 自动编译打包Debug包

on:
    push:
        branches:
            - wd
        paths-ignore:
            - '**.md'
            - '**.txt'
            - '.github/**'
            - '!.github/workflows/**'
            - "TMessagesProj/src/main/res/values**/**"
            - '.gitignore'
    workflow_dispatch:

jobs:
    build:
        name: Gradle Build
        if: ${{ github.event_name != 'pull_request' && success() && github.ref == 'refs/heads/wd' }}
        runs-on: ubuntu-latest
        env:
            CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
            CCACHE_NOHASHDIR: "true"
            CCACHE_MAXSIZE: "10G"
            CCACHE_HARDLINK: "true"
        steps:
            - uses: actions/checkout@v3

            - name: Get short SHA
              run: |
                  echo "SHA7=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_ENV

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: '17'
                  cache: 'gradle'

            - name: Artifact Build
              run: |
                  cat > service_account_credentials.json << EOF
                  ${{ secrets.ANDROID_PUBLISHER_CREDENTIALS }}"
                  EOF
                  ./gradlew TMessagesProj:assembleDebug
                  echo "APK_FILE=$(find TMessagesProj/build/outputs/apk -name '*arm64*.apk')" >> $GITHUB_ENV

            - uses: actions/upload-artifact@v3
              name: Upload apk (arm64-v8a)
              with:
                  name: Nnngram-arm64-v8a-${{ env.SHA7 }}
                  path: ${{ env.APK_FILE }}
