name: 自动编译打包Debug包

on:
    push:
        branches:
            - wd
        paths-ignore:
            - '**.md'
            - '**.txt'
            - '.github/**'
            - '!.github/workflows/**'
            - "TMessagesProj/src/main/res/values**/**"
            - '.gitignore'
    workflow_dispatch:

jobs:
    build:
        name: Gradle Build
        if: ${{ github.event_name != 'pull_request' && success() && github.ref == 'refs/heads/wd' }}
        runs-on: ubuntu-latest
        env:
            CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
            CCACHE_NOHASHDIR: "true"
            CCACHE_MAXSIZE: "10G"
            CCACHE_HARDLINK: "true"
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  # 添加子模块缓存
                  path: .
            - name: Check out submodules
              run: |
                git -c submodule."libs/rust".update=none submodule update --init --recursive

            # 添加Gradle缓存
            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                      .gradle
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # 添加Android SDK缓存
            - name: Cache Android SDK
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ env.ANDROID_HOME }}/build-tools
                      ${{ env.ANDROID_HOME }}/platforms
                  key: ${{ runner.os }}-android-sdk-${{ hashFiles('**/build.gradle*') }}
                  restore-keys: |
                      ${{ runner.os }}-android-sdk-

            - name: Get short SHA
              run: |
                  echo "SHA7=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_ENV

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'
                  cache: 'gradle'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v4
              with:
                  cache-read-only: true

            - name: Cache Android SDK
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ env.ANDROID_HOME }}/build-tools
                      ${{ env.ANDROID_HOME }}/platforms
                      ${{ env.ANDROID_HOME }}/ndk
                  key: ${{ runner.os }}-android-sdk-v36-${{ hashFiles('**/build.gradle*') }}
                  restore-keys: |
                      ${{ runner.os }}-android-sdk-v36-

            - name: Cache APT Packages
              uses: actions/cache@v4
              with:
                  path: /var/cache/apt/archives
                  key: ${{ runner.os }}-apt-build-deps-${{ hashFiles('.github/workflows/ci.yml') }}
                  restore-keys: |
                      ${{ runner.os }}-apt-build-deps-

            - name: Setup Android SDK Tools
              uses: android-actions/setup-android@v3
              with:
                  api-level: 36
                  build-tools: 36.0.2
                  ndk: 28.1.13356709

            - name: Prepare Environment
              run: |
                  echo "Removing large packages"
                  sudo apt-get remove -y '^dotnet-.*' aspnetcore-targeting-pack-6.0
                  sudo apt-get remove -y '^llvm-.*'
                  sudo apt-get remove -y 'php.*'
                  sudo apt-get remove -y '^mongodb-.*'
                  sudo apt-get remove -y '^mysql-.*'
                  sudo apt-get remove -y azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri
                  sudo apt-get autoremove -y
                  sudo apt-get clean
                  echo "Removing large directories"
                  sudo rm -rf /usr/share/dotnet/
                  sudo rm -rf /usr/local/graalvm/
                  sudo rm -rf /usr/local/.ghcup/
                  sudo rm -rf /usr/local/share/powershell
                  sudo rm -rf /usr/local/share/chromium
                  sudo rm -rf /usr/local/lib/node_modules
                  df -h
                  echo "Installing build dependencies"
                  sudo apt-get update -qq
                  sudo apt-get install -y bison gcc make curl ninja-build
                  echo "sdk.dir=${ANDROID_HOME}" >> local.properties

            - name: Set up ccache
              uses: hendrikmuhs/ccache-action@v1
              with:
                  path: ~/.ccache
                  key: ccache-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.c') }}
                  restore-keys: |
                      ccache-${{ runner.os }}-
                      ccache-
                      
            - name: Artifact Build
              run: |
                  # 设置错误时显示详细信息
                  set -e
                  
                  cat > service_account_credentials.json << EOF
                  ${{ secrets.ANDROID_PUBLISHER_CREDENTIALS }}"
                  EOF
                  
                  # 显示 ccache 状态
                  echo "=== ccache stats (before) ==="
                  ccache -s 2>/dev/null || echo "ccache not available"
                  
                  # 构建并捕获错误
                  echo "=== Starting build ==="
                  if ./gradlew TMessagesProj:assembleDebug --stacktrace --info 2>&1 | tee build.log; then
                      echo "=== Build succeeded ==="
                  else
                      echo "=== Build FAILED ==="
                      echo ""
                      echo "=== Last 100 lines of build log ==="
                      tail -100 build.log
                      
                      # 查找关键错误信息
                      echo ""
                      echo "=== Compilation Errors ==="
                      grep -i "error:" build.log | head -50 || echo "No error lines found"
                      
                      echo ""
                      echo "=== Build Failures ==="
                      grep -i "failure\|failed" build.log | head -30 || echo "No failure lines found"
                      
                      echo ""
                      echo "=== What went wrong ==="
                      grep -A5 "What went wrong" build.log || echo "No summary found"
                  fi
                  
                  # 显示 ccache 状态
                  echo "=== ccache stats (after) ==="
                  ccache -s 2>/dev/null || echo "ccache not available"
                  
                  # 如果构建成功，查找 APK
                  if [ -f build.log ]; then
                      APK_FILE=$(find TMessagesProj/build/outputs/apk -name '*arm64*.apk' 2>/dev/null | head -1)
                      if [ -n "$APK_FILE" ]; then
                          echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV
                      fi
                  fi
                  
                  # 如果构建失败，上传日志供查看
                  if [ ! -f "TMessagesProj/build/outputs/apk" ]; then
                      echo "Build failed - see error above"
                  fi

            - name: Upload Build Logs on Failure
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: build-logs-failed
                  path: build.log
                  retention-days: 7

            - name: Upload apk (arm64-v8a)
              if: env.APK_FILE != ''
              uses: actions/upload-artifact@v4
              with:
                  name: Nnngram-arm64-v8a-${{ env.SHA7 }}
                  path: ${{ env.APK_FILE }}
