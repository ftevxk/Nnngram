# AI 广告过滤模型训练指南

本指南介绍如何训练 TensorFlow Lite 模型用于 AI 广告过滤功能。

## 使用 Google Colab

### 步骤 1：打开 Colab

访问 https://colab.research.google.com/ 并新建笔记本

### 步骤 2：上传训练数据

将 `tools/ml_ad_filter/data/train.csv` 上传到 Colab

### 步骤 3：运行训练脚本

```python
# 1. 安装依赖
!pip install tensorflow pandas -q

# 2. 上传数据
from google.colab import files
files.upload()  # 上传 train.csv

# 3. 训练脚本
import pandas as pd
import numpy as np
import tensorflow as tf
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer

# 加载数据
df = pd.read_csv('train.csv')
texts = df['text'].tolist()
labels = [0 if l == 'ad' else 1 for l in df['label'].tolist()]

# 分割数据
X_train, X_test, y_train, y_test = train_test_split(texts, labels, test_size=0.2, random_state=42)

# TF-IDF 特征提取
vectorizer = TfidfVectorizer(max_features=5000, ngram_range=(1, 2))
X_train_tfidf = vectorizer.fit_transform(X_train).toarray()
X_test_tfidf = vectorizer.transform(X_test).toarray()

# 构建简单神经网络
model = tf.keras.Sequential([
    tf.keras.layers.Dense(64, activation='relu', input_shape=(X_train_tfidf.shape[1],)),
    tf.keras.layers.Dropout(0.3),
    tf.keras.layers.Dense(32, activation='relu'),
    tf.keras.layers.Dense(2, activation='softmax')
])

model.compile(optimizer='adam', loss='sparse_categorical_crossentropy', metrics=['accuracy'])
model.fit(X_train_tfidf, np.array(y_train), epochs=10, batch_size=16, validation_data=(X_test_tfidf, np.array(y_test)))

# 评估
loss, acc = model.evaluate(X_test_tfidf, np.array(y_test))
print(f"准确率: {acc:.4f}")

# 4. 转换为 TFLite
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]
tflite_model = converter.convert()

# 5. 保存并下载
with open('model.tflite', 'wb') as f:
    f.write(tflite_model)
with open('labels.txt', 'w') as f:
    f.write('ad\nnormal\n')

files.download('model.tflite')
files.download('labels.txt')
print("完成！")
```

### 步骤 4：部署模型

将下载的文件放入以下目录：

```
TMessagesProj/src/main/assets/ai_ad_filter/
├── model.tflite
└── labels.txt
```

### 部署

将 `output/model.tflite` 和 `output/labels.txt` 复制到 `assets/ai_ad_filter/` 目录。

## 训练数据格式

训练数据 CSV 文件格式如下：

```csv
text,label
"专业上分服务，安全可靠，微信：bet888",ad
"你好，最近怎么样？",normal
```

- `text`: 消息文本内容
- `label`: 标签（`ad` 表示广告，`normal` 表示正常消息）

## 模型配置

### 当前模型参数

| 参数 | 值 | 说明 |
|------|-----|------|
| max_features | 5000 | TF-IDF 最大特征数 |
| ngram_range | (1, 2) | 使用 1-gram 和 2-gram |
| 隐藏层 | 64 -> 32 | 神经网络结构 |
| epochs | 10 | 训练轮数 |
| batch_size | 16 | 批次大小 |

### 调整阈值

在应用设置中可以调整检测灵敏度阈值：
- 默认值：0.85
- 范围：0.0 - 1.0
- 较高的值会更严格，可能产生更多漏判
- 较低的值会更宽松，可能产生更多误判

## 故障排除

### TensorFlow 版本不兼容

如果遇到版本冲突，请使用以下版本：
```bash
pip install tensorflow==2.14.0
```

### Colab 内存不足

如果训练时内存不足，可以：
- 减小 `max_features` 参数
- 减小 `batch_size`
- 使用更简单的模型结构

### 模型预测不准确

增加训练数据或调整以下参数：
- 增加 `epochs`
- 调整 `ngram_range` 为 (1, 3)
- 增加 `max_features`
